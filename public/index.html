<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®æ—¶èŠå¤©å®¤</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .connection-area, .room-form {
      margin-bottom: 20px;
    }
    .chat-container {
      display: none;
      flex-grow: 1;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      height: 70vh;
    }
    .messages {
      flex-grow: 1;
      overflow-y: auto;
      margin-bottom: 10px;
      padding: 10px;
      background-color: #f9f9f9;
    }
    .message {
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 4px;
    }
    .message.own {
      background-color: #e1f5fe;
      text-align: right;
    }
    .message.other {
      background-color: #f5f5f5;
    }
    .user-info {
      font-weight: bold;
      font-size: 0.8em;
      color: #555;
    }
    input, button {
      padding: 8px;
      margin: 5px 0;
    }
    button {
      cursor: pointer;
    }
    .room-info {
      margin-bottom: 10px;
      padding: 5px;
      background-color: #f0f0f0;
      border-radius: 4px;
    }
    .message.system {
      background-color: #e8eaf6;
      color: #5c6bc0;
      font-style: italic;
      text-align: center;
    }
    .file-message {
      background-color: #e8f5e9;
      border: 1px dashed #81c784;
      padding: 10px;
      margin: 8px 0;
      border-radius: 4px;
    }
    .file-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .file-icon {
      font-size: 24px;
    }
    .file-details {
      flex-grow: 1;
    }
    .file-name {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .file-size {
      font-size: 0.8em;
      color: #666;
    }
    .file-actions {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }
    .file-upload-area {
      display: flex;
      align-items: center;
      margin-top: 10px;
      padding: 8px;
      border-top: 1px solid #eee;
    }
    .upload-progress {
      display: none;
      width: 100%;
      height: 10px;
      background-color: #e0e0e0;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 5px;
    }
    .progress-bar {
      height: 100%;
      background-color: #4caf50;
      width: 0%;
      transition: width 0.3s;
    }
    .download-btn {
      background-color: #4caf50;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85em;
    }
    .download-btn:hover {
      background-color: #388e3c;
    }
    .file-input {
      display: none;
    }
    .file-label {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      padding: 6px 12px;
      background-color: #f0f0f0;
      border-radius: 4px;
    }
    .file-label:hover {
      background-color: #e0e0e0;
    }
  </style>ge.system.error {
</head>ackground-color: #ffebee;
<body>color: #c62828;
  <div class="container">
    <h1>å®æ—¶èŠå¤©å®¤</h1>
    style>
    <div class="connection-area">
      <h2>è¿æ¥åˆ°æœåŠ¡å™¨</h2>
      <input type="text" id="username" placeholder="è¾“å…¥æ‚¨çš„ç”¨æˆ·å">
    <h1>å®æ—¶èŠå¤©å®¤</h1>
    
    <div class="connection-area">
      <h2>è¿æ¥åˆ°æœåŠ¡å™¨</h2>
      <input type="text" id="username" placeholder="è¾“å…¥æ‚¨çš„ç”¨æˆ·å">
      <button id="connect-btn">è¿æ¥</button>
      <div id="connection-status"></div>
    </div>
    
    <div class="room-form">
      <h2>åŠ å…¥/åˆ›å»ºèŠå¤©å®¤</h2>
      <input type="text" id="room-id" placeholder="è¾“å…¥èŠå¤©å®¤ID">
      <button id="join-btn" disabled>åŠ å…¥èŠå¤©å®¤</button>
    </div>
    
    <div class="chat-container" id="chat-container">
      <div class="room-info" id="room-info">èŠå¤©å®¤: <span id="current-room"></span> | åœ¨çº¿: <span id="user-count">0</span>äºº</div>
      <div class="messages" id="messages"></div>
      <div class="input-area">
        <input type="text" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
        <button id="send-btn">å‘é€</button>
          <input type="file" id="file-input" class="file-input">
          <div class="upload-progress" id="upload-progress">
            <div class="progress-bar" id="progress-bar"></div>
          </div>n class="file-icon">ğŸ“</span> é€‰æ‹©æ–‡ä»¶
        </div>bel>
          <input type="file" id="file-input" class="file-input">
          <div class="upload-progress" id="upload-progress">
            <div class="progress-bar" id="progress-bar"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let currentUser = null;
    // ç”¨äºå­˜å‚¨æ–‡ä»¶ä¼ è¾“çš„å¯¹ç­‰è¿æ¥
    const peerConnections = {};
    // ç”¨äºå­˜å‚¨å‘èµ·çš„æ–‡ä»¶ä¼ è¾“
    const fileTransfers = {};
    // ç”¨äºå­˜å‚¨å¾…ä¸‹è½½æ–‡ä»¶
    const availableFiles = {};
    
    // DOMå…ƒç´ 
    const connectBtn = document.getElementById('connect-btn');
    const usernameInput = document.getElementById('username');
    const connectionStatus = document.getElementById('connection-status');
    const joinBtn = document.getElementById('join-btn');
    const roomIdInput = document.getElementById('room-id');
    const chatContainer = document.getElementById('chat-container');
    const currentRoomSpan = document.getElementById('current-room');
    const userCountSpan = document.getElementById('user-count');
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const leaveBtn = document.getElementById('leave-btn');
    const fileInput = document.getElementById('file-input');
    const uploadProgress = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    
    // è¿æ¥åˆ°æœåŠ¡å™¨
    connectBtn.addEventListener('click', () => {
      const username = usernameInput.value.trim() || 'åŒ¿åç”¨æˆ·';
      
      socket.emit('user-connect', { username });
      connectionStatus.textContent = 'è¿æ¥ä¸­...';
      
      connectBtn.disabled = true;
      usernameInput.disabled = true;
    });
    
    // åŠ å…¥èŠå¤©å®¤
    joinBtn.addEventListener('click', () => {
      const roomId = roomIdInput.value.trim();
      if (roomId) {
        socket.emit('join-room', roomId);
        roomIdInput.disabled = true;
        joinBtn.disabled = true;
      }
    });
    
    // å‘é€æ¶ˆæ¯
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
    
    function sendMessage() {
      const content = messageInput.value.trim();
      if (content) {
        socket.emit('send-message', { content });
        messageInput.value = '';
      }
    }
      roomIdInput.disabled = false;
      joinBtn.disabled = false;
      roomIdInput.value = '';('click', () => {
      socket.emit('leave-room');
      chatContainer.style.display = 'none';
      roomIdInput.disabled = false;
      joinBtn.disabled = false;
      roomIdInput.value = '';
    });
    
    // æ–‡ä»¶ä¸Šä¼ å¤„ç†
    fileInput.addEventListener('change', (e) => {
      progressBar.style.width = '0%';
      if (!file) return;
      // å‡†å¤‡æ–‡ä»¶ä¿¡æ¯
      const fileInfo = {
        id: Date.now() + Math.random().toString(36).substr(2, 5),
      progressBar.style.width = '0%';
      
      // å‡†å¤‡æ–‡ä»¶ä¿¡æ¯
      const fileInfo = {
        id: Date.now() + Math.random().toString(36).substr(2, 5),
        name: file.name,
        type: file.type,
        size: file.size,
        lastModified: file.lastModified
      };
      
      // å‘é€æ–‡ä»¶ä¿¡æ¯åˆ°æœåŠ¡å™¨
        info: fileInfo,-info', fileInfo);
        chunks: Math.ceil(file.size / (64 * 1024))
      }; å­˜å‚¨æ–‡ä»¶ä»¥å¤‡ä¼ è¾“
      fileTransfers[fileInfo.id] = {
      // æ·»åŠ åˆ°è‡ªå·±çš„æ¶ˆæ¯åŒºåŸŸ
      const fileMessage = {
        id: fileInfo.id,l(file.size / (64 * 1024))
        type: 'file',
        fileInfo: fileInfo,
        sender: currentUser,
        timestamp: Date.now()
      };id: fileInfo.id,
        type: 'file',
      displayFileMessage(fileMessage, true);
        sender: currentUser,
      // é‡ç½®æ–‡ä»¶è¾“å…¥æ¡†p: Date.now()
      fileInput.value = '';
      uploadProgress.style.display = 'none';
    });isplayFileMessage(fileMessage, true);
      
    // Socket.io äº‹ä»¶å¤„ç†
    socket.on('connection-established', (data) => {
      if (data.success) {e.display = 'none';
        connectionStatus.textContent = 'å·²è¿æ¥ï¼ç”¨æˆ·ID: ' + data.userId;
        currentUser = {
          id: data.userId,
          username: usernameInput.value.trim() || 'åŒ¿åç”¨æˆ·'
      if (data.success) {
        connectionStatus.textContent = 'å·²è¿æ¥ï¼ç”¨æˆ·ID: ' + data.userId;
        currentUser = {
          id: data.userId,
          username: usernameInput.value.trim() || 'åŒ¿åç”¨æˆ·'
        };
        joinBtn.disabled = false;
      } else {
        connectionStatus.textContent = 'è¿æ¥å¤±è´¥: ' + data.message;
        connectBtn.disabled = false;
        usernameInput.disabled = false;
      }
    });
    
    socket.on('room-joined', (data) => {
      currentRoomSpan.textContent = data.roomId;
      userCountSpan.textContent = data.userCount;
      chatContainer.style.display = 'flex';
      
      // æ¸…ç©ºæ¶ˆæ¯åŒºåŸŸ
      messagesDiv.innerHTML = '';f (msg.type === 'file') {
          displayFileMessage(msg);
      // æ˜¾ç¤ºå†å²æ¶ˆæ¯
      data.messages.forEach(msg => {   displayMessage(msg);
        displayMessage(msg);    }
      });
      
      messageInput.focus();essageInput.focus();
    });});
    
    socket.on('new-message', (message) => {
      displayMessage(message);displayMessage(message);
    });
    
    socket.on('user-joined', (data) => {
      userCountSpan.textContent = data.userCount;erCount;
      
      const noticeDiv = document.createElement('div');onst noticeDiv = document.createElement('div');
      noticeDiv.className = 'message system';  noticeDiv.className = 'message system';
      noticeDiv.textContent = `${data.user.username} åŠ å…¥äº†èŠå¤©å®¤`;user.username} åŠ å…¥äº†èŠå¤©å®¤`;
      messagesDiv.appendChild(noticeDiv);
      scrollToBottom();scrollToBottom();
    });
    
    socket.on('user-left', (data) => {
      userCountSpan.textContent = data.userCount;erCount;
      
      const noticeDiv = document.createElement('div');onst noticeDiv = document.createElement('div');
      noticeDiv.className = 'message system';  noticeDiv.className = 'message system';
      noticeDiv.textContent = `${data.username} ç¦»å¼€äº†èŠå¤©å®¤`;ata.username} ç¦»å¼€äº†èŠå¤©å®¤`;
      messagesDiv.appendChild(noticeDiv);eDiv);
      scrollToBottom();crollToBottom();
    });});
    
    socket.on('error', (data) => {
      alert(`é”™è¯¯: ${data.message}`);;
    });
    
    socket.on('disconnect', () => {
      connectionStatus.textContent = 'å·²æ–­å¼€è¿æ¥';onnectionStatus.textContent = 'å·²æ–­å¼€è¿æ¥';
      connectBtn.disabled = false;  connectBtn.disabled = false;
      usernameInput.disabled = false;
      joinBtn.disabled = true;
      chatContainer.style.display = 'none';chatContainer.style.display = 'none';
    });
    
    socket.on('new-file', (fileMessage) => {
      displayFileMessage(fileMessage);ge);
      
      // å­˜å‚¨å¯ä¸‹è½½æ–‡ä»¶ä¿¡æ¯/ å­˜å‚¨å¯ä¸‹è½½æ–‡ä»¶ä¿¡æ¯
      availableFiles[fileMessage.fileInfo.id] = {  availableFiles[fileMessage.fileInfo.id] = {
        senderId: fileMessage.fileInfo.senderId,d: fileMessage.fileInfo.senderId,
        info: fileMessage.fileInfo
      };
    });  const { type, senderId, fileId, chunk, chunkIndex, totalChunks, sdp, ice, targetId } = data;;
    
    // å¤„ç†æ–‡ä»¶ä¼ è¾“ä¿¡ä»¤
    socket.on('file-transfer-signal', async (data) => {   peerConnections[senderId] = createPeerConnection(senderId);ket.on('file-transfer-signal', async (data) => {
      const { type, senderId, fileId, chunk, chunkIndex, totalChunks, sdp, ice, targetId } = data;  }const { type, senderId, fileId, chunk, chunkIndex, totalChunks, sdp, ice, targetId } = data;
      
      if (!peerConnections[senderId]) {  const pc = peerConnections[senderId];if (!peerConnections[senderId]) {
        peerConnections[senderId] = createPeerConnection(senderId);= createPeerConnection(senderId);
      }
      ype === 'offer') {
      const pc = peerConnections[senderId];
      SessionDescription(sdp));
      // å¤„ç†å„ç§WebRTCä¿¡ä»¤r();
      if (type === 'offer') {  await pc.setLocalDescription(answer);type === 'offer') {
        try {
          await pc.setRemoteDescription(new RTCSessionDescription(sdp));le-transfer-signal', {eDescription(new RTCSessionDescription(sdp));
          const answer = await pc.createAnswer();.createAnswer();
          await pc.setLocalDescription(answer);answer);
           sdp: pc.localDescription
          socket.emit('file-transfer-signal', {nsfer-signal', {
            type: 'answer',
            targetId: senderId,   console.error('å¤„ç†offeræ—¶å‡ºé”™:', err);   targetId: senderId,
            sdp: pc.localDescriptionè¿æ¥æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•');
          });
        } catch (err) {
          console.error('å¤„ç†offeræ—¶å‡ºé”™:', err);ræ—¶å‡ºé”™:', err);
        } RTCSessionDescription(sdp));
      } else if (type === 'answer') { } catch (err) {lse if (type === 'answer') {
        try {ræ—¶å‡ºé”™:', err);
          await pc.setRemoteDescription(new RTCSessionDescription(sdp));howErrorNotification('å»ºç«‹è¿æ¥æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•');it pc.setRemoteDescription(new RTCSessionDescription(sdp));
        } catch (err) {
          console.error('å¤„ç†answeræ—¶å‡ºé”™:', err);
        }ry {
      } else if (type === 'ice') {= 'ice') {
        try {TCIceCandidate(ice));
          if (ice) {   } if (ice) {
            await pc.addIceCandidate(new RTCIceCandidate(ice)););
          }ror('å¤„ç†ICEå€™é€‰æ—¶å‡ºé”™:', err);
        } catch (err) {
          console.error('å¤„ç†ICEå€™é€‰æ—¶å‡ºé”™:', err);   }   console.error('å¤„ç†ICEå€™é€‰æ—¶å‡ºé”™:', err);
        } } else if (type === 'file-request') { }
      } else if (type === 'file-request') {      // æ”¶åˆ°æ–‡ä»¶è¯·æ±‚ï¼Œå¼€å§‹ä¼ è¾“  } else if (type === 'file-request') {
        // æ”¶åˆ°æ–‡ä»¶è¯·æ±‚ï¼Œå¼€å§‹ä¼ è¾“);
        sendFileInChunks(fileId, senderId);
      }
    });
    
    function createPeerConnection(peerId) {n createPeerConnection(peerId) {
      const pc = new RTCPeerConnection({ pc = new RTCPeerConnection({
        iceServers: [iceServers: [
          { urls: 'stun:stun.l.google.com:19302' }, 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' }
        ] = document.createElement('div');
      });iceDiv.className = 'message system error';
      noticeDiv.textContent = `é”™è¯¯: ${message}`;
      // åˆ›å»ºæ•°æ®é€šé“
      const dataChannel = pc.createDataChannel('fileTransfer', {scrollToBottom();const dataChannel = pc.createDataChannel('fileTransfer', {
        ordered: true
      });;
      atePeerConnection(peerId) {
      dataChannel.binaryType = 'arraybuffer';({uffer';
      
      setupDataChannel(dataChannel, peerId);' },
      stun1.l.google.com:19302' }
      // ç›‘å¬ICEå€™é€‰
      pc.onicecandidate = (event) => {
        if (event.candidate) {ndidate) {
          socket.emit('file-transfer-signal', {åˆ›å»ºæ•°æ®é€šé“ socket.emit('file-transfer-signal', {
            type: 'ice',nst dataChannel = pc.createDataChannel('fileTransfer', {    type: 'ice',
            targetId: peerId,  ordered: true      targetId: peerId,
            ice: event.candidatendidate
          });
        }
      };
      setupDataChannel(dataChannel, peerId);
      // å¤„ç†è¿œç¨‹æ•°æ®é€šé“å˜äº‹ä»¶
      pc.ondatachannel = (event) => { pc.onconnectionstatechange = () => { // ç›‘å¬ICEå€™é€‰ pc.ondatachannel = (event) => {
        setupDataChannel(event.channel, peerId);    console.log(`ä¸ ${peerId} çš„è¿æ¥çŠ¶æ€: ${pc.connectionState}`);  pc.onicecandidate = (event) => {    setupDataChannel(event.channel, peerId);
      };
      nectionState === 'failed' || pc.connectionState === 'disconnected') {mit('file-transfer-signal', {
      return pc;tion(`ä¸ç”¨æˆ·çš„è¿æ¥å·²æ–­å¼€ï¼Œæ–‡ä»¶ä¼ è¾“å¯èƒ½å¤±è´¥`);
    }
    
    function setupDataChannel(channel, peerId) {
      // å­˜å‚¨æ¥æ”¶åˆ°çš„æ–‡ä»¶å—
      let receivedSize = 0;
      let fileSize = 0;t fileSize = 0;
      let fileName = '';channel, peerId) {
      let fileType = '';
      let fileId = '';t receivedSize = 0;setupDataChannel(event.channel, peerId);t fileId = '';
      let receivedChunks = [];let fileSize = 0;};let receivedChunks = [];
      
      channel.onopen = () => {
        console.log(`ä¸ ${peerId} çš„æ•°æ®é€šé“å·²æ‰“å¼€`);t fileId = '';sole.log(`ä¸ ${peerId} çš„æ•°æ®é€šé“å·²æ‰“å¼€`);
      };let receivedChunks = [];
      
      channel.onclose = () => {
        console.log(`ä¸ ${peerId} çš„æ•°æ®é€šé“å·²å…³é—­`);console.log(`ä¸ ${peerId} çš„æ•°æ®é€šé“å·²æ‰“å¼€`);t receivedSize = 0;console.log(`ä¸ ${peerId} çš„æ•°æ®é€šé“å·²å…³é—­`);
      };};let fileSize = 0;};
      
      channel.onerror = (error) => {
        console.error(`æ•°æ®é€šé“é”™è¯¯:`, error);console.log(`ä¸ ${peerId} çš„æ•°æ®é€šé“å·²å…³é—­`);t fileId = '';console.error(`æ•°æ®é€šé“é”™è¯¯:`, error);
      };
      
      channel.onmessage = (event) => {
        const data = event.data;nsole.error(`æ•°æ®é€šé“é”™è¯¯:`, error);nsole.log(`ä¸ ${peerId} çš„æ•°æ®é€šé“å·²æ‰“å¼€`);nst data = event.data;
        
        // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™æ˜¯å…ƒæ•°æ®
        if (typeof data === 'string') {{
          const metadata = JSON.parse(data);
          
          if (metadata.type === 'file-start') {
            // å¼€å§‹æ¥æ”¶æ–°æ–‡ä»¶string') {r) => {
            fileId = metadata.fileId;parse(data); error);leId;
            fileName = metadata.fileName;me = metadata.fileName;
            fileSize = metadata.fileSize;
            fileType = metadata.fileType;// å¼€å§‹æ¥æ”¶æ–°æ–‡ä»¶l.onmessage = (event) => {fileType = metadata.fileType;
            receivedSize = 0;
            receivedChunks = [];data.fileName;
            
            console.log(`å¼€å§‹æ¥æ”¶æ–‡ä»¶: ${fileName}, å¤§å°: ${fileSize} å­—èŠ‚`);fileType = metadata.fileType;typeof data === 'string') {console.log(`å¼€å§‹æ¥æ”¶æ–‡ä»¶: ${fileName}, å¤§å°: ${fileSize} å­—èŠ‚`);
            
          } else if (metadata.type === 'file-end') {receivedChunks = [];se if (metadata.type === 'file-end') {
            // æ–‡ä»¶æ¥æ”¶å®Œæˆï¼Œç»„åˆæ‰€æœ‰å—= 'file-start') {ï¼Œç»„åˆæ‰€æœ‰å—
            console.log(`æ–‡ä»¶æ¥æ”¶å®Œæˆ: ${fileName}`);èŠ‚`);
            fileId = metadata.fileId;
            const fileBlob = new Blob(receivedChunks, { type: fileType });ata.type === 'file-end') {adata.fileName; = new Blob(receivedChunks, { type: fileType });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥æ¥æ”¶å®Œæˆ: ${fileName}`);data.fileType;
            const downloadLink = URL.createObjectURL(fileBlob);
             Blob(receivedChunks, { type: fileType });
            // æ›´æ–°UIï¼Œæ·»åŠ ä¸‹è½½æŒ‰é’®
            const fileElem = document.getElementById(`file-${fileId}`);le-${fileId}`);
            if (fileElem) {jectURL(fileBlob);
              const downloadBtn = fileElem.querySelector('.download-btn');
              if (downloadBtn) {æ›´æ–°UIï¼Œæ·»åŠ ä¸‹è½½æŒ‰é’®æ–‡ä»¶æ¥æ”¶å®Œæˆï¼Œç»„åˆæ‰€æœ‰å—f (downloadBtn) {
                downloadBtn.href = downloadLink;onst fileElem = document.getElementById(`file-${fileId}`);onsole.log(`æ–‡ä»¶æ¥æ”¶å®Œæˆ: ${fileName}`);   downloadBtn.href = downloadLink;
                downloadBtn.download = fileName;if (fileElem) {    downloadBtn.download = fileName;
                downloadBtn.disabled = false;ownloadBtn = fileElem.querySelector('.download-btn');eBlob = new Blob(receivedChunks, { type: fileType });oadBtn.disabled = false;
                downloadBtn.textContent = 'ä¸‹è½½æ–‡ä»¶';
              }     downloadBtn.href = downloadLink; // åˆ›å»ºä¸‹è½½é“¾æ¥   }
            }downloadBtn.download = fileName;t downloadLink = URL.createObjectURL(fileBlob);
            Btn.disabled = false;
            // æ¸…é™¤æ¥æ”¶å˜é‡ent = 'ä¸‹è½½æ–‡ä»¶';
            receivedChunks = [];);
          }  }  if (fileElem) {}
        } else {wnloadBtn = fileElem.querySelector('.download-btn');
          // äºŒè¿›åˆ¶æ•°æ®ï¼Œæ¥æ”¶æ–‡ä»¶å—
          receivedChunks.push(data);  receivedChunks = [];      downloadBtn.href = downloadLink;receivedChunks.push(data);
          receivedSize += data.byteLength;nload = fileName;e += data.byteLength;
          
          // æ›´æ–°è¿›åº¦n.textContent = 'ä¸‹è½½æ–‡ä»¶';
          const progress = Math.round((receivedSize / fileSize) * 100);
          .byteLength;
          // æ›´æ–°UIæ˜¾ç¤ºè¿›åº¦
          const fileElem = document.getElementById(`file-${fileId}`);æ›´æ–°è¿›åº¦/ æ¸…é™¤æ¥æ”¶å˜é‡st fileElem = document.getElementById(`file-${fileId}`);
          if (fileElem) {onst progress = Math.round((receivedSize / fileSize) * 100); receivedChunks = [];f (fileElem) {
            const progressBar = fileElem.querySelector('.progress-bar');  }   const progressBar = fileElem.querySelector('.progress-bar');
            if (progressBar) {  // æ›´æ–°UIæ˜¾ç¤ºè¿›åº¦} else {    if (progressBar) {
              progressBar.style.width = `${progress}%`;    const fileElem = document.getElementById(`file-${fileId}`);    // äºŒè¿›åˆ¶æ•°æ®ï¼Œæ¥æ”¶æ–‡ä»¶å—        progressBar.style.width = `${progress}%`;
            }m) {nks.push(data);
          }       const progressBar = fileElem.querySelector('.progress-bar');     receivedSize += data.byteLength;     }
        }        if (progressBar) {          }
      }; progressBar.style.width = `${progress}%`;æ›´æ–°è¿›åº¦
      ileSize) * 100);
      return channel;
    }
    };    const fileElem = document.getElementById(`file-${fileId}`);
    // è¯·æ±‚ä¸‹è½½æ–‡ä»¶
    function requestFile(fileId) {return channel;      const progressBar = fileElem.querySelector('.progress-bar');nction requestFile(fileId) {
      const fileInfo = availableFiles[fileId];leId];
      if (!fileInfo) return;
      
      const { senderId } = fileInfo;tion requestFile(fileId) {  }nst { senderId } = fileInfo;
      = availableFiles[fileId];
      // å¦‚æœæ²¡æœ‰ä¸å‘é€è€…çš„è¿æ¥ï¼Œåˆ›å»ºä¸€ä¸ª
      if (!peerConnections[senderId]) {eerConnections[senderId]) {
        peerConnections[senderId] = createPeerConnection(senderId); = fileInfo;derId] = createPeerConnection(senderId);
        
        // åˆ›å»ºå¹¶å‘é€offerä¸€ä¸ª
        const pc = peerConnections[senderId];
        erId] = createPeerConnection(senderId);eId) {
        pc.createOffer()
          .then(offer => pc.setLocalDescription(offer))
          .then(() => {c = peerConnections[senderId];
            socket.emit('file-transfer-signal', {nderId } = fileInfo;socket.emit('file-transfer-signal', {
              type: 'offer',)
              targetId: senderId,> pc.setLocalDescription(offer))ä¸€ä¸ª senderId,
              sdp: pc.localDescription
            });fer-signal', { createPeerConnection(senderId);
          })
          .then(() => {erId,
            // å‘é€æ–‡ä»¶è¯·æ±‚ä¿¡ä»¤dp: pc.localDescriptionc = peerConnections[senderId];å‘é€æ–‡ä»¶è¯·æ±‚ä¿¡ä»¤
            socket.emit('file-transfer-signal', {});et.emit('file-transfer-signal', {
              type: 'file-request',
              targetId: senderId,n(() => {n(offer => pc.setLocalDescription(offer))targetId: senderId,
              fileId: fileIdId
            });', {', {
          })st',
          .catch(err => console.error('åˆ›å»ºofferå‡ºé”™:', err));rId,rId,le.error('åˆ›å»ºofferå‡ºé”™:', err));
      } else {leIdcalDescription
        // å·²æœ‰è¿æ¥ï¼Œç›´æ¥å‘é€æ–‡ä»¶è¯·æ±‚ }); });å·²æœ‰è¿æ¥ï¼Œç›´æ¥å‘é€æ–‡ä»¶è¯·æ±‚
        socket.emit('file-transfer-signal', {   })   }) socket.emit('file-transfer-signal', {
          type: 'file-request',    .catch(err => console.error('åˆ›å»ºofferå‡ºé”™:', err));    .then(() => {    type: 'file-request',
          targetId: senderId,senderId,
          fileId: fileId
        });file-transfer-signal', {file-request',
      }
      Id,Id
      // æ›´æ–°UIæ˜¾ç¤ºè¯·æ±‚çŠ¶æ€
      const fileElem = document.getElementById(`file-${fileId}`);
      if (fileElem) {catch(err => console.error('åˆ›å»ºofferå‡ºé”™:', err));(fileElem) {
        const downloadBtn = fileElem.querySelector('.download-btn');else { const downloadBtn = fileElem.querySelector('.download-btn');
        if (downloadBtn) { // æ›´æ–°UIæ˜¾ç¤ºè¯·æ±‚çŠ¶æ€   // å·²æœ‰è¿æ¥ï¼Œç›´æ¥å‘é€æ–‡ä»¶è¯·æ±‚   if (downloadBtn) {
          downloadBtn.textContent = 'æ¥æ”¶ä¸­...';  const fileElem = document.getElementById(`file-${fileId}`);    socket.emit('file-transfer-signal', {      downloadBtn.textContent = 'æ¥æ”¶ä¸­...';
          downloadBtn.disabled = true;lem) { 'file-request',oadBtn.disabled = true;
        }r('.download-btn');
      }
    }ntent = 'æ¥æ”¶ä¸­...';
        downloadBtn.disabled = true;}
    // å‘é€æ–‡ä»¶ï¼ˆåˆ†å—ï¼‰
    function sendFileInChunks(fileId, targetId) {
      const transfer = fileTransfers[fileId];entById(`file-${fileId}`); fileTransfers[fileId];
      if (!transfer) return; (fileElem) {if (!transfer) return;
      dBtn = fileElem.querySelector('.download-btn');
      const { file, info } = transfer;argetId) {
      const pc = peerConnections[targetId];
      if (!pc) return;
      
      // è·å–æˆ–åˆ›å»ºæ•°æ®é€šé“
      let dataChannel = pc.dataChannel;etId];
      if (!dataChannel || dataChannel.readyState !== 'open') {f (!pc) return;!dataChannel || dataChannel.readyState !== 'open') {
        dataChannel = pc.createDataChannel('fileTransfer'); å‘é€æ–‡ä»¶ï¼ˆåˆ†å—ï¼‰  dataChannel = pc.createDataChannel('fileTransfer');
        dataChannel.binaryType = 'arraybuffer';æ•°æ®é€šé“endFileInChunks(fileId, targetId) {annel.binaryType = 'arraybuffer';
        setupDataChannel(dataChannel, targetId);;ileId];targetId);
        pc.dataChannel = dataChannel;yState !== 'open') {
      } pc.createDataChannel('fileTransfer');
      yType = 'arraybuffer';} = transfer;
      // æ–‡ä»¶è¯»å–å™¨
      const reader = new FileReader();  pc.dataChannel = dataChannel;if (!pc) return;const reader = new FileReader();
      const chunkSize = 64 * 1024; // 64KB// 64KB
      let offset = 0;
      let chunkIndex = 0;
      const totalChunks = Math.ceil(file.size / chunkSize);w FileReader();|| dataChannel.readyState !== 'open') { = Math.ceil(file.size / chunkSize);
       1024; // 64KBateDataChannel('fileTransfer');
      // å‘é€æ–‡ä»¶å…ƒæ•°æ®rraybuffer';
      dataChannel.send(JSON.stringify({annel, targetId);stringify({
        type: 'file-start',eil(file.size / chunkSize);nnel;
        fileId: fileId,ileId,
        fileName: file.name,// å‘é€æ–‡ä»¶å…ƒæ•°æ®  fileName: file.name,
        fileSize: file.size,.send(JSON.stringify({le.size,
        fileType: file.type,er();
        totalChunks: totalChunks
      }));
      
      // è¯»å–å¹¶å‘é€æ–‡ä»¶å—type, = Math.ceil(file.size / chunkSize);
      reader.onload = (e) => {talChunks: totalChunksnload = (e) => {
        if (dataChannel.readyState === 'open') {eadyState === 'open') {
          dataChannel.send(e.target.result);
          offset += e.target.result.byteLength;
          chunkIndex++;er.onload = (e) => {leId: fileId,chunkIndex++;
          .readyState === 'open') {name,
          // æ›´æ–°è¿›åº¦.result);
          const progress = Math.round((offset / file.size) * 100);rget.result.byteLength;ype, = Math.round((offset / file.size) * 100);
          progressBar.style.width = `${progress}%`;ex++;s: totalChunksBar.style.width = `${progress}%`;
          
          // ç»§ç»­è¯»å–ä¸‹ä¸€å—æˆ–ç»“æŸ
          if (offset < file.size) {.round((offset / file.size) * 100);
            readSlice();width = `${progress}%`; {
          } else {l.readyState === 'open') { {
            // å‘é€æ–‡ä»¶ç»“æŸä¿¡å· ç»§ç»­è¯»å–ä¸‹ä¸€å—æˆ–ç»“æŸtaChannel.send(e.target.result);// å‘é€æ–‡ä»¶ç»“æŸä¿¡å·
            dataChannel.send(JSON.stringify({ < file.size) {e.target.result.byteLength;nel.send(JSON.stringify({
              type: 'file-end',
              fileId: fileId
            })); // å‘é€æ–‡ä»¶ç»“æŸä¿¡å·/ æ›´æ–°è¿›åº¦ }));
               dataChannel.send(JSON.stringify({ const progress = Math.round((offset / file.size) * 100);   
            // é‡ç½®è¿›åº¦æ¡      type: 'file-end',  progressBar.style.width = `${progress}%`;    // é‡ç½®è¿›åº¦æ¡
            uploadProgress.style.display = 'none';        fileId: fileId          uploadProgress.style.display = 'none';
            progressBar.style.width = '0%';å–ä¸‹ä¸€å—æˆ–ç»“æŸressBar.style.width = '0%';
          }
        }
      }; = 'none';
          progressBar.style.width = '0%';    // å‘é€æ–‡ä»¶ç»“æŸä¿¡å·
      // è¯»å–æ–‡ä»¶å—å‡½æ•°    }      dataChannel.send(JSON.stringify({// è¯»å–æ–‡ä»¶å—å‡½æ•°
      const readSlice = () => {e: 'file-end',eadSlice = () => {
        const slice = file.slice(offset, offset + chunkSize);e = file.slice(offset, offset + chunkSize);
        reader.readAsArrayBuffer(slice);        }));   reader.readAsArrayBuffer(slice);
      };  // è¯»å–æ–‡ä»¶å—å‡½æ•°          };
      eadSlice = () => {/ é‡ç½®è¿›åº¦æ¡
      // å¼€å§‹è¯»å–ze);
      readSlice();
    }
      }
    // æ˜¾ç¤ºæ–‡ä»¶æ¶ˆæ¯
    function displayFileMessage(message, isOwn = false) {
      const { fileInfo, sender } = message;
      const isOwnMessage = isOwn || (currentUser && sender.id === currentUser.id);nst readSlice = () => {const isOwnMessage = isOwn || (currentUser && sender.id === currentUser.id);
      
      const messageDiv = document.createElement('div');sOwn = false) {ent('div');
      messageDiv.className = `message ${isOwnMessage ? 'own' : 'other'}`;
      messageDiv.id = `message-${message.id}`;ntUser && sender.id === currentUser.id);
      // å¼€å§‹è¯»å–
      const userInfoDiv = document.createElement('div');');
      userInfoDiv.className = 'user-info';sOwnMessage ? 'own' : 'other'}`;
      userInfoDiv.textContent = isOwnMessage ? 'æˆ‘' : sender.username;id}`;
      messageDiv.appendChild(userInfoDiv); æ˜¾ç¤ºæ–‡ä»¶æ¶ˆæ¯messageDiv.appendChild(userInfoDiv);
      {
      const fileDiv = document.createElement('div');;nt('div');
      fileDiv.className = 'file-message';userInfoDiv.textContent = isOwnMessage ? 'æˆ‘' : sender.username;const isOwnMessage = isOwn || (currentUser && sender.id === currentUser.id);fileDiv.className = 'file-message';
      fileDiv.id = `file-${fileInfo.id}`;
      
      const fileInfoDiv = document.createElement('div');ateElement('div');age ${isOwnMessage ? 'own' : 'other'}`;.createElement('div');
      fileInfoDiv.className = 'file-info';;.id}`;';
      fileDiv.id = `file-${fileInfo.id}`;
      const fileIcon = document.createElement('div');
      fileIcon.className = 'file-icon';('div');
      fileIcon.textContent = 'ğŸ“„';fileInfoDiv.className = 'file-info';userInfoDiv.textContent = isOwnMessage ? 'æˆ‘' : sender.username;fileIcon.textContent = 'ğŸ“„';
      fileInfoDiv.appendChild(fileIcon);
      lement('div');
      const fileDetailsDiv = document.createElement('div');iv');eElement('div');
      fileDetailsDiv.className = 'file-details';
      fileInfoDiv.appendChild(fileIcon);fileDiv.id = `file-${fileInfo.id}`;
      const fileName = document.createElement('div');
      fileName.className = 'file-name';reateElement('div');teElement('div');
      fileName.textContent = fileInfo.name;
      fileDetailsDiv.appendChild(fileName);
      const fileName = document.createElement('div');const fileIcon = document.createElement('div');
      const fileSize = document.createElement('div');
      fileSize.className = 'file-size';ame;
      fileSize.textContent = formatFileSize(fileInfo.size);fileDetailsDiv.appendChild(fileName);fileInfoDiv.appendChild(fileIcon);fileSize.textContent = formatFileSize(fileInfo.size);
      fileDetailsDiv.appendChild(fileSize);
      
      fileInfoDiv.appendChild(fileDetailsDiv);
      fileDiv.appendChild(fileInfoDiv);leSize.textContent = formatFileSize(fileInfo.size);Div.appendChild(fileInfoDiv);
      
      if (!isOwnMessage) {
        const fileActionsDiv = document.createElement('div');Div);e;reateElement('div');
        fileActionsDiv.className = 'file-actions';nfoDiv);d(fileName);e = 'file-actions';
        
        const downloadBtn = document.createElement('a');createElement('div');ocument.createElement('a');
        downloadBtn.className = 'download-btn';ment.createElement('div');ze';wnload-btn';
        downloadBtn.textContent = 'è¯·æ±‚ä¸‹è½½';leActionsDiv.className = 'file-actions';Size.textContent = formatFileSize(fileInfo.size);wnloadBtn.textContent = 'è¯·æ±‚ä¸‹è½½';
        downloadBtn.href = '#';
        downloadBtn.onclick = (e) => {const downloadBtn = document.createElement('a');wnloadBtn.onclick = (e) => {
          e.preventDefault();n';);
          requestFile(fileInfo.id);downloadBtn.textContent = 'è¯·æ±‚ä¸‹è½½';leDiv.appendChild(fileInfoDiv);  requestFile(fileInfo.id);
        };tn.href = '#';
        fileActionsDiv.appendChild(downloadBtn);
        
        fileDiv.appendChild(fileActionsDiv);
        };
        // æ·»åŠ è¿›åº¦æ˜¾ç¤º
        const progressDiv = document.createElement('div');
        progressDiv.className = 'upload-progress';);gress';
        progressDiv.style.display = 'block';downloadBtn.href = '#';progressDiv.style.display = 'block';
        
        const progressBarDiv = document.createElement('div');teElement('div');('div');
        progressBarDiv.className = 'progress-bar'; progressDiv.className = 'upload-progress';   requestFile(fileInfo.id); progressBarDiv.className = 'progress-bar';
        progressBarDiv.style.width = '0%';  progressDiv.style.display = 'block';  };  progressBarDiv.style.width = '0%';
        
        progressDiv.appendChild(progressBarDiv);eateElement('div');
        fileDiv.appendChild(progressDiv);className = 'progress-bar';hild(fileActionsDiv);hild(progressDiv);
      }   progressBarDiv.style.width = '0%';    }
              // æ·»åŠ è¿›åº¦æ˜¾ç¤º  
      messageDiv.appendChild(fileDiv);ssDiv.appendChild(progressBarDiv);progressDiv = document.createElement('div');iv.appendChild(fileDiv);
      messagesDiv.appendChild(messageDiv);Div);oad-progress';eDiv);
      scrollToBottom();
    }
    
    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatFileSize(bytes) { scrollToBottom();   progressBarDiv.style.width = '0%';unction formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' bytes';}      if (bytes < 1024) return bytes + ' bytes';
      else if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';2) + ' KB';
      else if (bytes < 1073741824) return (bytes / 1048576).toFixed(2) + ' MB';
      else return (bytes / 1073741824).toFixed(2) + ' GB';
    }if (bytes < 1024) return bytes + ' bytes';
    
    function displayMessage(message) {else if (bytes < 1073741824) return (bytes / 1048576).toFixed(2) + ' MB';messagesDiv.appendChild(messageDiv);nction displayMessage(message) {
      const messageDiv = document.createElement('div');';
      const isOwnMessage = currentUser && message.sender.id === currentUser.id;
      
      messageDiv.className = `message ${isOwnMessage ? 'own' : 'other'}`;
      const messageDiv = document.createElement('div');nction formatFileSize(bytes) {const isOwnMessage = currentUser && message.sender.id === currentUser.id;
      const userInfoDiv = document.createElement('div');r.id === currentUser.id;
      userInfoDiv.className = 'user-info'; 'other'}`;
      userInfoDiv.textContent = isOwnMessage ? 'æˆ‘' : message.sender.username;sOwnMessage ? 'own' : 'other'}`; (bytes / 1048576).toFixed(2) + ' MB';
      messageDiv.appendChild(userInfoDiv);else return (bytes / 1073741824).toFixed(2) + ' GB';const userInfoDiv = document.createElement('div');
      lement('div');
      const contentDiv = document.createElement('div');Name = 'user-info';ge ? 'æˆ‘' : message.sender.username;
      contentDiv.textContent = message.content; userInfoDiv.textContent = isOwnMessage ? 'æˆ‘' : message.sender.username;unction displayMessage(message) { messageDiv.appendChild(userInfoDiv);
      messageDiv.appendChild(contentDiv);  messageDiv.appendChild(userInfoDiv);  const messageDiv = document.createElement('div');  
      .id === currentUser.id;nt.createElement('div');
      messagesDiv.appendChild(messageDiv);
      scrollToBottom(); contentDiv.textContent = message.content; messageDiv.className = `message ${isOwnMessage ? 'own' : 'other'}`; messageDiv.appendChild(contentDiv);
    }geDiv.appendChild(contentDiv);
    nst userInfoDiv = document.createElement('div');essagesDiv.appendChild(messageDiv);
    function scrollToBottom() {essagesDiv.appendChild(messageDiv);serInfoDiv.className = 'user-info';crollToBottom();
      messagesDiv.scrollTop = messagesDiv.scrollHeight;      scrollToBottom();      userInfoDiv.textContent = isOwnMessage ? 'æˆ‘' : message.sender.username;    }





</html></body>  </script>    }








</html></body>  </script>    }      messagesDiv.scrollTop = messagesDiv.scrollHeight;    function scrollToBottom() {        }
















</html></body>  </script>    }      messagesDiv.scrollTop = messagesDiv.scrollHeight;    function scrollToBottom() {        }      scrollToBottom();      messagesDiv.appendChild(messageDiv);            messageDiv.appendChild(contentDiv);      contentDiv.textContent = message.content;      const contentDiv = document.createElement('div');            messageDiv.appendChild(userInfoDiv);    
    function scrollToBottom() {
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  </script>
</body>
</html>
